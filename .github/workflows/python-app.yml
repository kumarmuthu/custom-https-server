# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python


name: custom-https-server CI
on:
  workflow_dispatch:
  push:
   branches: [ "main" ]
  pull_request:
   branches: [ "main" ]
  schedule:
    - cron: "0 9 1 * *"
 
jobs:
  test-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install psutil
      
      - name: Create HTTPS test script
        run: |
          echo '#!/usr/bin/env python3' > test_https.py
          echo 'import socket' >> test_https.py
          echo 'import ssl' >> test_https.py
          echo 'import sys' >> test_https.py
          echo '' >> test_https.py
          echo 'def test_server(port):' >> test_https.py
          echo '    try:' >> test_https.py
          echo '        context = ssl.create_default_context()' >> test_https.py
          echo '        context.check_hostname = False' >> test_https.py
          echo '        context.verify_mode = ssl.CERT_NONE' >> test_https.py
          echo '        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)' >> test_https.py
          echo '        sock.settimeout(5)' >> test_https.py
          echo '        with context.wrap_socket(sock, server_hostname="localhost") as ssock:' >> test_https.py
          echo '            ssock.connect(("127.0.0.1", port))' >> test_https.py
          echo '            print(f"✅ Connected to HTTPS server on port {port}")' >> test_https.py
          echo '            return True' >> test_https.py
          echo '    except Exception as e:' >> test_https.py
          echo '        print(f"❌ Failed to connect to port {port}: {e}")' >> test_https.py
          echo '        return False' >> test_https.py
          echo '' >> test_https.py
          echo 'if __name__ == "__main__":' >> test_https.py
          echo '    port = int(sys.argv[1])' >> test_https.py
          echo '    success = test_server(port)' >> test_https.py
          echo '    sys.exit(0 if success else 1)' >> test_https.py
      
      - name: Run server with --path . on port 8080
        working-directory: ./custom-https-server
        run: |
          echo "Launching server with --path . on port 8080"
          python3 custom_https_server.py --path . --port 8080 --bind 127.0.0.1 --mode read --user admin --pass password > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 15
          echo "Testing HTTPS connection on port 8080..."
          python3 ../test_https.py 8080
          kill $SERVER_PID 2>/dev/null || true
        shell: bash
      
      - name: Run server with --path /tmp on port 8081
        working-directory: ./custom-https-server
        run: |
          echo "Creating dummy file in /tmp"
          echo "Hello from /tmp" > /tmp/test.txt
          echo "Launching server with --path /tmp on port 8081"
          python3 custom_https_server.py --path /tmp --port 8081 --bind 127.0.0.1 --mode read --user admin --pass password > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          sleep 15
          echo "Testing HTTPS connection on port 8081..."
          python3 ../test_https.py 8081
          kill $SERVER_PID 2>/dev/null || true
        shell: bash
